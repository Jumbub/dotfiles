#!/usr/bin/env bash

CONFIG_EDITOR=vim
LOCATION_REPOS=$HOME/repos

alias asource="source $HOME/.aliases"
alias zsource="source $HOME/.zshrc"

LOCATION_DOTFILES_REPO_GIT=${LOCATION_REPOS}/dotfiles.git
LOCATION_GIT_IGNORE=${HOME}/.gitignore
dotoverride() {
  git --git-dir=${LOCATION_DOTFILES_REPO_GIT} --work-tree=$HOME $@
}
dotstatus() {
  dotoverride status $@
}
dotdiff() {
  dotoverride diff $@
}
dotcommit() {
  INPUT=$@
  cd $HOME
  dotoverride add .
  cd -
  dotoverride commit -m "${INPUT}"
}
dotamend() {
  cd $HOME
  dotoverride add .
  cd -
  dotoverride commit --amend --no-edit
}
dotpush() {
  dotoverride push $@
}
dotadd() {(
  if [[ $1 ]]; then
    # Split the string by the "/" delimiter
    PATH_SPLIT=("${(s|/|)${1}}")
    BUILT_STRING="!"
    for PATH_PART in $PATH_SPLIT; do
      BUILT_STRING="${BUILT_STRING}/${PATH_PART}"
      # If the built string is already in the file, do not append again
      if ! grep -q "${BUILT_STRING}" "${LOCATION_GIT_IGNORE}"; then
        # Add the file/folder to the gitignore
        echo $BUILT_STRING >> $LOCATION_GIT_IGNORE
      fi
    done
  else
    echo "dotadd <PATH>"
  fi
)}
dotbackup() {(
  # This file needs to exist for the ls-files command option
  touch $HOME/.gitignore

  # Create backup folder
  BACKUP_TIME_NOW="$(date +%s)"
  BACKUP_FOLDER=$HOME/.dotfiles-backup/$BACKUP_TIME_NOW
  mkdir -p $BACKUP_FOLDER

  dotoverride ls-files --modified | xargs -i cp {} $BACKUP_FOLDER 2>/dev/null

  # Attempt to delete directory (only succeeds if folder is empty)
  rmdir $BACKUP_FOLDER --ignore-fail-on-non-empty

  # Give some info to the user
  if [ -d "$BACKUP_FOLDER" ]
  then
    echo "Modified files:"
    ls -a --ignore="." --ignore=".." $BACKUP_FOLDER
    echo
    echo "Backups saved to $HOME/.dotfiles-backup/$BACKUP_TIME_NOW"
  else
    echo "Nothing to update"
  fi
)}
dotcheckout() {
  dotoverride fetch
  dotbackup
  cd $HOME
  dotoverride checkout -- .
  cd -
  echo "You may need to reload your terminal."
}
dotpull() {
  dotoverride fetch
  dotoverride pull
  echo "You may need to reload your terminal."
}