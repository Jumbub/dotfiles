#!/bin/bash

CONFIG_EDITOR=vim
LOCATION_REPOS=$HOME/repos

alias a_source="source $HOME/.aliases"
alias z_source="source $HOME/.zshrc"

LOCATION_DOTFILES_REPO=${LOCATION_REPOS}/dotfiles
LOCATION_GIT_IGNORE=${HOME}/.gitignore
alias dot_override="git --git-dir=${LOCATION_DOTFILES_REPO}/.git --work-tree=$HOME"
dot_add() {
  if [[ $1 ]]; then
    # Split the string by the "/" delimiter
    PATH_SPLIT=("${(s|/|)${1}}")
    BUILT_STRING="!"
    for PATH_PART in $PATH_SPLIT; do
      BUILT_STRING="${BUILT_STRING}/${PATH_PART}"
      # If the built string is already in the file, do not append again
      if ! grep -q "${BUILT_STRING}" "${LOCATION_GIT_IGNORE}"; then
        # Add the file/folder to the gitignore
        echo $BUILT_STRING >> $LOCATION_GIT_IGNORE
      fi
    done
    unset BUILT_STRING
  else
    echo "dot_add <PATH>"
  fi
}
dot_backup() {
  BACKUP_TIME_NOW="$(date +%s)"
  mkdir -p $HOME/.dotfiles-backup/$BACKUP_TIME_NOW
  # This file needs to exist for the ls-files command option
  touch .gitignore
  dot_override ls-files --modified | xargs -i cp {} ~/.dotfiles-backup/$BACKUP_TIME_NOW
  unset BACKUP_TIME_NOW
}
dot_status() {
  dot_override status
}
dot_diff() {
  dot_override diff
}
dot_checkout() {
  dot_override fetch
  dot_backup
  cd $HOME
  dot_override checkout -- .
  cd -
}
dot_update() {
  INPUT=$@
  dot_override add .
  dot_override commit -m "${INPUT}"
  dot_override push
}